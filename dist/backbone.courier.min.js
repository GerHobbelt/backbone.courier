/*
 * Backbone.Courier, v0.5.10
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
(function(e,t){var n=/^(\S+)\s*(.*)$/,i=t.isFunction($)?$("body")[0]:null;e.Courier={},e.Courier.add=function(e){function a(e){t.isFunction(e.$el.data)&&!e.$el.data("view")&&e.$el.data("view",e)}function s(e){var i=this.uiBindings||t.result(this,"ui");if(!i)return e;var a={};return t.each(e,function(e,s){var r=s.match(n),l=r[1],o=r[2];if(""!==o&&!t.isUndefined(i[o])){var u=i[o];s=l+" "+u}a[s]=e}),a}function r(e,i,a){var s=[];for(var r in e){var l=r.match(n),o=l[1],u=l[2],c=RegExp(o.replace("*","[\\w]*"));c.test(i.name)&&(""===u||a._getChildViewNamed(u)===i.source)&&s.push({eventName:o,subviewName:u,value:e[r]})}return s.length>1&&(s=t.sortBy(s,function(e){var t=e.eventName.replace("*",""),n=""!==e.subviewName,i=(n?1e3:0)+t.length;return-i})),s.length?s[0].value:null}var l={delegateEvents:e.delegateEvents,setElement:e.setElement};e.spawn=function(n,i){if(t.isString(n))n={name:n,data:t.extend({},i)};else if(t.isUndefined(n.name))throw Error("Undefined message name.");n.source=e,n.data=n.data||{};for(var a,s,l="!"===n.name[n.name.length-1],o=this._getParentView();o;){if(t.isObject(o.onMessages)&&(s=r(o.onMessages,n,o),null!==s)){var u=s;if(t.isFunction(u)||(u=o[s]),!u)throw Error('Method "'+s+'" does not exist');var c=u.call(o,n);if(l)return c}a=!1;var v=t.result(o,"passMessages");if(t.isObject(v))if(s=r(v,n,o),null!==s){if("."===s);else if(t.isString(s))n.name=s;else{if(!t.isFunction(s))throw new TypeError;var h=n.data;n.data={},s.call(o,n,h)}a=!0}else l&&(a=!0);if(l&&(a=!0),!a)break;n.source=o,o=o._getParentView()}if(l)throw Error('Round trip message "'+n.name+'" was not handled. All round trip messages must be handled.')},t.isFunction(e._getParentView)||(e._getParentView=function(){for(var e=null,t=this.$el.parent();t.length>0&&t[0]!==i;){var n=t.data("view");if(n&&n.el){e=n;break}t=t.parent()}return e}),t.isFunction(e._getChildViewNamed)||(e._getChildViewNamed=function(e){return t.isObject(this.subviews)?this.subviews[e]:null}),e.delegateEvents=function(e){var i=this;t.isFunction(this.events)&&(this.events=this.events.call(this.events)),e=e||t.clone(this.events)||{},e=s.call(this,e);var a=t.result(this,"spawnMessages")||{};a=s.call(this,a),t.each(a,function(a,s){var r=s.match(n),l=r[1];r[2];var o=function(e){e&&e.preventDefault&&e.preventDefault(),e&&e.stopPropagation&&e.stopPropagation();var n;if(t.isFunction(a))n={name:l,data:{},source:i},a.call(this,n,e);else{if(!t.isString(a))throw new TypeError;n=a}this.spawn(n)};if(e[s]){var u=e[s];if(t.isFunction(u)||(u=i[e[s]]),!u)throw Error('Method "'+e[s]+'" does not exist');e[s]=function(){u.apply(this,arguments),o.apply(this,arguments)}}else e[s]=o}),l.delegateEvents.call(this,e)},e.setElement=function(t,n){l.setElement.call(this,t,n),a(e)},a(e),e.delegateEvents()}})(Backbone,_);