/*
 * Backbone.Courier, v1.0.0
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
(function(e,n){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],n):"undefined"!=typeof exports?module.exports=n(require("underscore"),require("backbone"),require("backbone").$):n(e._,e.Backbone,e.jQuery||e.Zepto||e.$)})(this,function(e,n,t){var r=/^(\S+)\s*(.*)$/,i=e.isFunction(t)?t("body")[0]:null;return n.Courier={},n.Courier.add=function(t){function a(n){e.isFunction(n.$el.data)&&!n.$el.data("view")&&n.$el.data("view",n)}function s(n,t,i){var a=[];for(var s in n){var o=s.match(r),u=o[1],l=o[2],d=RegExp(u.replace("*","[\\w]*"));d.test(t.name)&&(""===l||i._getChildViewNamed(l)===t.source)&&a.push({eventName:u,subviewName:l,value:n[s]})}return a.length>1&&(a=e.sortBy(a,function(e){var n=e.eventName.replace("*",""),t=""!==e.subviewName,r=(t?1e3:0)+n.length;return-r})),a.length?a[0].value:null}var o={setElement:t.setElement};t.spawn=function(n,r){if(e.isString(n))n={name:n,data:e.extend({},r)};else if(e.isUndefined(n.name))throw Error("Undefined message name.");n.source=t,n.data=n.data||{},this.trigger(n.name,n.data);for(var i,a,o="!"===n.name[n.name.length-1],u=this._getParentView();u;){if(e.isObject(u.onMessages)&&(a=s(u.onMessages,n,u),null!==a)){var l=a;if(e.isFunction(l)||(l=u[a]),!l)throw Error('Method "'+a+'" does not exist');var d=l.call(u,n.data,n.source,n.name);if(o)return d}i=!1;var f=e.result(u,"passMessages");if(e.isObject(f))if(a=s(f,n,u),null!==a){if("."===a);else{if(!e.isString(a))throw new TypeError("Values of passMessages hash should be strings.");n.name=a}i=!0}else o&&(i=!0);if(o&&(i=!0),!i)break;n.source=u,u=u._getParentView()}if(o)throw Error('Round trip message "'+n.name+'" was not handled. All round trip messages must be handled.')},e.isFunction(t._getParentView)||(t._getParentView=function(){for(var e=null,t=this.$el.parent();t.length>0&&t[0]!==i;){var r=t.data("view");if(r&&r instanceof n.View){e=r;break}t=t.parent()}return e}),e.isFunction(t._getChildViewNamed)||(t._getChildViewNamed=function(n){return e.isObject(this.subviews)?this.subviews[n]:null}),t.setElement=function(e,n){o.setElement.call(this,e,n),a(t)},t.$el&&a(t)},n.Courier});