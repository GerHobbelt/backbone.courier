/*
 * Backbone.Courier, v0.6.0
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
(function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],t):"undefined"!=typeof exports?module.exports=t(require("underscore"),require("backbone"),require("backbone").$):t(e._,e.Backbone,e.jQuery||e.Zepto||e.$)})(this,function(e,t,n){var i=/^(\S+)\s*(.*)$/,a=e.isFunction(n)?n("body")[0]:null;return t.Courier={},t.Courier.add=function(n){function s(t){e.isFunction(t.$el.data)&&!t.$el.data("view")&&t.$el.data("view",t),t.delegateEvents()}function r(t,n,a){var s=[];for(var r in t){var o=r.match(i),l=o[1],u=o[2],d=RegExp(l.replace("*","[\\w]*"));d.test(n.name)&&(""===u||a._getChildViewNamed(u)===n.source)&&s.push({eventName:l,subviewName:u,value:t[r]})}return s.length>1&&(s=e.sortBy(s,function(e){var t=e.eventName.replace("*",""),n=""!==e.subviewName,i=(n?1e3:0)+t.length;return-i})),s.length?s[0].value:null}var o={delegateEvents:n.delegateEvents,setElement:n.setElement};n.spawn=function(t,i){if(e.isString(t))t={name:t,data:e.extend({},i)};else if(e.isUndefined(t.name))throw Error("Undefined message name.");t.source=n,t.data=t.data||{};for(var a,s,o="!"===t.name[t.name.length-1],l=this._getParentView();l;){if(e.isObject(l.onMessages)&&(s=r(l.onMessages,t,l),null!==s)){var u=s;if(e.isFunction(u)||(u=l[s]),!u)throw Error('Method "'+s+'" does not exist');var d=u.call(l,t);if(o)return d}a=!1;var c=e.result(l,"passMessages");if(e.isObject(c))if(s=r(c,t,l),null!==s){if("."===s);else if(e.isString(s))t.name=s;else{if(!e.isFunction(s))throw new TypeError;var f=t.data;t.data={},s.call(l,t,f)}a=!0}else o&&(a=!0);if(o&&(a=!0),!a)break;t.source=l,l=l._getParentView()}if(o)throw Error('Round trip message "'+t.name+'" was not handled. All round trip messages must be handled.')},e.isFunction(n._getParentView)||(n._getParentView=function(){for(var e=null,n=this.$el.parent();n.length>0&&n[0]!==a;){var i=n.data("view");if(i&&i instanceof t.View){e=i;break}n=n.parent()}return e}),e.isFunction(n._getChildViewNamed)||(n._getChildViewNamed=function(t){return e.isObject(this.subviews)?this.subviews[t]:null}),n.delegateEvents=function(t){var n=this;e.isFunction(this.events)&&(this.events=this.events.call(this.events)),t=t||e.clone(this.events)||{};var a=e.result(this,"spawnMessages")||{};e.isFunction(this._exapandUIHandlesInHash)&&(a=this._exapandUIHandlesInHash(a)),e.each(a,function(a,s){var r=s.match(i),o=r[1];r[2];var l=function(t){t&&t.preventDefault&&t.preventDefault(),t&&t.stopPropagation&&t.stopPropagation();var i;if(e.isFunction(a))i={name:o,data:{},source:n},a.call(this,i,t);else{if(!e.isString(a))throw new TypeError;i=a}this.spawn(i)};if(t[s]){var u=t[s];if(e.isFunction(u)||(u=n[t[s]]),!u)throw Error('Method "'+t[s]+'" does not exist');t[s]=function(){u.apply(this,arguments),l.apply(this,arguments)}}else t[s]=l}),o.delegateEvents.call(this,t)},n.setElement=function(e,t){o.setElement.call(this,e,t),s(n)},this.el&&s(n)},t.Courier});